<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãƒ©ãƒ³ãƒ€ãƒ è¦³å…‰ã‚¹ãƒãƒƒãƒˆææ¡ˆ | Google Maps + Places</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans JP", sans-serif }
    #app { display: grid; grid-template-columns: 360px 1fr; grid-template-rows: auto 1fr; height: 100%; }
    header { grid-column: 1 / -1; padding: 12px 16px; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; gap: 12px; }
    header h1 { font-size: 18px; margin: 0; }
    #controls { padding: 12px; border-right: 1px solid #e5e7eb; overflow: auto; }
    #map { position: relative; }
    #map, #pano { width: 100%; height: 100%; }
    .row { margin-bottom: 12px; }
    label { display: block; font-size: 12px; color: #374151; margin-bottom: 4px; }
    select, input[type="number"], input[type="text"] { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 8px; }
    input[type="checkbox"] { transform: translateY(1px); }
    button { cursor: pointer; padding: 10px 12px; border-radius: 10px; border: 1px solid #d1d5db; background: #111827; color: white; font-weight: 600; }
    button.secondary { background: white; color: #111827; }
    .stack { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .muted { color: #6b7280; font-size: 12px; }
    .place-card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px; margin-top: 8px; background:#fff; }
    .photo { width: 100%; border-radius: 8px; object-fit: cover; aspect-ratio: 16/9; background: #f3f4f6; }
    .split { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .tabs { display:flex; gap:8px; }
    .tab { padding:8px 10px; border-radius:999px; border:1px solid #e5e7eb; background:#fff; font-size:12px; cursor:pointer }
    .tab.active { background:#111827; color:#fff; }
    @media (max-width: 900px) {
      #app { grid-template-columns: 1fr; grid-template-rows: auto auto 1fr; }
      #controls { border-right: none; border-bottom:1px solid #e5e7eb; }
      .split { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <h1>ğŸ² ãƒ©ãƒ³ãƒ€ãƒ è¦³å…‰ã‚¹ãƒãƒƒãƒˆææ¡ˆ</h1>
      <span class="muted">ç¾åœ¨åœ°ã¾ãŸã¯ä»»æ„ã®å ´æ‰€ã®è¿‘ãã‹ã‚‰ã€ãƒ©ãƒ³ãƒ€ãƒ ã§ã‚¹ãƒãƒƒãƒˆã‚’1ä»¶ãŠã™ã™ã‚ã—ã¾ã™ã€‚</span>
    </header>

    <section id="controls">
      <div class="row">
        <label>æ¤œç´¢åŸºæº–ä½ç½®ï¼ˆç·¯åº¦,çµŒåº¦ï¼‰ <span class="muted">ç©ºãªã‚‰ç¾åœ¨åœ°ã‚’ä½¿ç”¨</span></label>
        <div class="split">
          <input id="lat" type="text" placeholder="ä¾‹) 35.681236" />
          <input id="lng" type="text" placeholder="ä¾‹) 139.767125" />
        </div>
        <div class="stack" style="margin-top:8px">
          <button id="use-geoloc" class="secondary">ğŸ“ ç¾åœ¨åœ°ã‚’å–å¾—</button>
          <span id="geoloc-status" class="muted"></span>
        </div>
      </div>

      <div class="row">
        <label>ã‚¹ãƒãƒƒãƒˆã®ç¨®é¡ï¼ˆPlaces typeï¼‰</label>
        <select id="type">
          <option value="tourist_attraction">tourist_attractionï¼ˆè¦³å…‰åæ‰€ï¼‰</option>
          <option value="cafe">cafeï¼ˆã‚«ãƒ•ã‚§ï¼‰</option>
          <option value="restaurant">restaurantï¼ˆãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ï¼‰</option>
          <option value="park">parkï¼ˆå…¬åœ’ï¼‰</option>
          <option value="museum">museumï¼ˆåšç‰©é¤¨ï¼‰</option>
          <option value="book_store">book_storeï¼ˆæœ¬å±‹ï¼‰</option>
          <option value="aquarium">aquariumï¼ˆæ°´æ—é¤¨ï¼‰</option>
          <option value="art_gallery">art_galleryï¼ˆç¾è¡“é¤¨ï¼‰</option>
          <option value="shopping_mall">shopping_mallï¼ˆã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ï¼‰</option>
          <option value="point_of_interest">point_of_interestï¼ˆä½•ã§ã‚‚ï¼‰</option>
        </select>
      </div>

      <div class="row">
        <label>æ¤œç´¢åŠå¾„ï¼ˆmï¼‰</label>
        <input id="radius" type="number" min="100" max="50000" step="100" value="2000" />
      </div>

      <div class="row stack">
        <label class="stack"><input id="open-now" type="checkbox" /> å–¶æ¥­ä¸­ã®ã¿</label>
        <label class="stack"><input id="min4" type="checkbox" /> â˜…4.0ä»¥ä¸Š</label>
        <label class="stack"><input id="photoOnly" type="checkbox" /> å†™çœŸã‚ã‚Šã®ã¿</label>
      </div>

      <div class="row stack">
        <button id="random">ğŸ² ãƒ©ãƒ³ãƒ€ãƒ ã§é¸ã¶</button>
        <button id="another" class="secondary">ğŸ” åˆ¥ã®å€™è£œ</button>
      </div>

      <div id="result" class="place-card" hidden>
        <img id="photo" class="photo" alt="place photo" />
        <h3 id="name"></h3>
        <div id="meta" class="muted"></div>
        <div id="addr" style="margin-top:6px"></div>
        <div class="stack" style="margin-top:8px">
          <a id="gmapLink" target="_blank"><button class="secondary">ğŸ§­ Googleãƒãƒƒãƒ—ã§é–‹ã</button></a>
          <a id="callLink" target="_blank" hidden><button class="secondary">ğŸ“ é›»è©±</button></a>
          <button id="detailsBtn">â„¹ï¸ è©³ç´°</button>
        </div>
      </div>

      <details style="margin-top:12px">
        <summary>âš™ï¸ é–‹ç™ºè€…å‘ã‘ãƒ’ãƒ³ãƒˆ</summary>
        <ul>
          <li>ã“ã®ãƒšãƒ¼ã‚¸ã‚’ãƒ›ã‚¹ãƒˆã™ã‚‹éš›ã¯ <strong>?key=YOUR_API_KEY&language=ja&region=JP&libraries=places</strong> ã‚’ä½¿ã„ã¾ã™ã€‚</li>
          <li>APIã‚­ãƒ¼ã¯ <em>HTTP ãƒªãƒ•ã‚¡ãƒ©åˆ¶é™</em> ã‚’å¿…ãšè¨­å®šã—ã¦ãã ã•ã„ï¼ˆlocalhost ã¨æœ¬ç•ªãƒ‰ãƒ¡ã‚¤ãƒ³ï¼‰ã€‚</li>
          <li>èª²é‡‘ã¯æœ‰åŠ¹åŒ–ãŒå¿…è¦ã§ã™ã€‚Nearby Searchãƒ»Place Detailsãƒ»Static Street View ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚</li>
        </ul>
      </details>
    </section>

    <section id="map"></section>
  </div>

  <script>
    // === ä½¿ç”¨æ–¹æ³• ===
    // 1) ä¸‹ã® <script src="https://maps.googleapis.com/maps/api/js?..."> ã® YOUR_API_KEY ã‚’å·®ã—æ›¿ãˆã€‚
    // 2) ãƒ­ãƒ¼ã‚«ãƒ«ã§é–‹ãã‹ã€é™çš„ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã«é…ç½®ã€‚
    // 3) ã€ŒğŸ“ç¾åœ¨åœ°ã‚’å–å¾—ã€â†’ã€ŒğŸ²ãƒ©ãƒ³ãƒ€ãƒ ã§é¸ã¶ã€ã§ä½¿ãˆã¾ã™ã€‚

    let map, marker, service, panorama;
    let lastResults = [];
    let currentIndex = -1;
    let currentCenter = { lat: 35.681236, lng: 139.767125 }; // æ±äº¬é§…ï¼ˆç¾åœ¨åœ°å–å¾—å¤±æ•—æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: currentCenter,
        zoom: 14,
        mapTypeControl: false,
        streetViewControl: true,
        fullscreenControl: true,
      });
      service = new google.maps.places.PlacesService(map);

      // åˆæœŸãƒãƒ¼ã‚«ãƒ¼
      marker = new google.maps.Marker({ map, position: currentCenter });

      // Street View ãƒ‘ãƒãƒ«
      panorama = new google.maps.StreetViewPanorama(document.createElement('div'), {
        pov: { heading: 34, pitch: 10 },
        visible: false,
      });
      map.setStreetView(panorama);

      // UI ãƒªã‚¹ãƒŠãƒ¼
      document.getElementById('use-geoloc').addEventListener('click', useGeolocation);
      document.getElementById('random').addEventListener('click', () => runSearch(true));
      document.getElementById('another').addEventListener('click', () => pickAnother());
      document.getElementById('detailsBtn').addEventListener('click', fetchDetailsForCurrent);
    }

    function useGeolocation() {
      const status = document.getElementById('geoloc-status');
      status.textContent = 'å–å¾—ä¸­â€¦';
      if (!navigator.geolocation) {
        status.textContent = 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚';
        return;
      }
      navigator.geolocation.getCurrentPosition(pos => {
        currentCenter = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        updateCenterInputs(currentCenter);
        map.setCenter(currentCenter);
        marker.setPosition(currentCenter);
        status.textContent = `ç·¯åº¦:${currentCenter.lat.toFixed(5)} çµŒåº¦:${currentCenter.lng.toFixed(5)}`;
      }, err => {
        console.warn(err);
        status.textContent = 'ç¾åœ¨åœ°å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¨©é™ãƒ»è¨­å®šã‚’ç¢ºèªï¼‰';
      }, { enableHighAccuracy: true, timeout: 8000 });
    }

    function centerFromInputs() {
      const latV = parseFloat(document.getElementById('lat').value);
      const lngV = parseFloat(document.getElementById('lng').value);
      if (!isNaN(latV) && !isNaN(lngV)) {
        return { lat: latV, lng: lngV };
      }
      return currentCenter; // ç¾åœ¨åœ° or æ—¢å®š
    }

    function updateCenterInputs({lat, lng}) {
      document.getElementById('lat').value = lat.toFixed(6);
      document.getElementById('lng').value = lng.toFixed(6);
    }

    function runSearch(resetIndex = true) {
      const type = document.getElementById('type').value;
      const radius = Math.min(50000, Math.max(100, parseInt(document.getElementById('radius').value || '2000')));
      const openNow = document.getElementById('open-now').checked;
      const min4 = document.getElementById('min4').checked;
      const photoOnly = document.getElementById('photoOnly').checked;

      const center = centerFromInputs();
      currentCenter = center;
      map.setCenter(center);
      marker.setPosition(center);

      const req = {
        location: center,
        radius,
        type,
        openNow: openNow || undefined,
        language: 'ja',
        region: 'JP',
      };

      service.nearbySearch(req, (results, status, pagination) => {
        if (status !== google.maps.places.PlacesServiceStatus.OK || !results?.length) {
          alert('å€™è£œãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ¡ä»¶ã‚’ç·©ã‚ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
          return;
        }
        // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ•ã‚£ãƒ«ã‚¿
        let filtered = results;
        if (min4) filtered = filtered.filter(r => (r.rating || 0) >= 4);
        if (photoOnly) filtered = filtered.filter(r => Array.isArray(r.photos) && r.photos.length > 0);
        if (!filtered.length) filtered = results; // ãƒ•ã‚£ãƒ«ã‚¿ã§ç©ºã«ãªã£ãŸã‚‰å…ƒã«æˆ»ã™

        lastResults = filtered;
        if (resetIndex) currentIndex = -1;
        pickAnother();
      });
    }

    function pickAnother() {
      if (!lastResults.length) {
        runSearch();
        return;
      }
      // ãƒ©ãƒ³ãƒ€ãƒ ã«æ¬¡ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹é¸æŠï¼ˆåŒã˜ã‚’é€£ç¶šã§é¿ã‘ã‚‹ï¼‰
      let next;
      if (lastResults.length === 1) {
        next = 0;
      } else {
        do { next = Math.floor(Math.random() * lastResults.length); } while (next === currentIndex);
      }
      currentIndex = next;
      const place = lastResults[currentIndex];
      showPlace(place);
    }

    function showPlace(place) {
      const pos = place.geometry?.location;
      if (pos) {
        map.panTo(pos);
        map.setZoom(16);
        marker.setPosition(pos);
      }
      const resultEl = document.getElementById('result');
      const photoEl = document.getElementById('photo');
      const nameEl = document.getElementById('name');
      const metaEl = document.getElementById('meta');
      const addrEl = document.getElementById('addr');
      const gmapLink = document.getElementById('gmapLink');
      const callLink = document.getElementById('callLink');

      nameEl.textContent = place.name || 'åç§°ä¸æ˜';
      const rating = place.rating ? `â˜…${place.rating.toFixed(1)}ï¼ˆ${place.user_ratings_total || 0}ä»¶ï¼‰` : 'è©•ä¾¡ãªã—';
      metaEl.textContent = [rating, place.types?.[0]].filter(Boolean).join(' Â· ');

      // ä½æ‰€ã‚„å–¶æ¥­çŠ¶æ³ã¯ Details ã§ã‚ˆã‚Šæ­£ç¢ºã«å–å¾—ã§ãã‚‹ãŒã€è¿‘å‚æ¤œç´¢ã®çµæœã«ã‚‚è¿‘ä¼¼ã‚ã‚Š
      addrEl.textContent = place.vicinity || '';

      // å†™çœŸ
      if (place.photos?.length) {
        photoEl.src = place.photos[0].getUrl({ maxWidth: 1200, maxHeight: 800 });
        photoEl.hidden = false;
      } else {
        photoEl.hidden = true;
        photoEl.removeAttribute('src');
      }

      // Googleãƒãƒƒãƒ—ã¸ã®å°ç·š
      const q = encodeURIComponent(place.name + (place.vicinity ? ' ' + place.vicinity : ''));
      gmapLink.href = `https://www.google.com/maps/search/?api=1&query=${q}`;

      // é›»è©±ã¯ Details å–å¾—å¾Œã«è¨­å®š
      callLink.href = '#';
      callLink.hidden = true;

      resultEl.hidden = false;

      // ã‚¹ãƒˆãƒªãƒ¼ãƒˆãƒ“ãƒ¥ãƒ¼ã‚’ãƒˆãƒ©ã‚¤ï¼ˆãªã‘ã‚Œã°éè¡¨ç¤ºï¼‰
      const sv = new google.maps.StreetViewService();
      sv.getPanorama({ location: pos, radius: 80 }, (data, status) => {
        if (status === 'OK') {
          panorama.setPano(data.location.pano);
          panorama.setPov({ heading: 34, pitch: 10 });
          panorama.setVisible(true);
        } else {
          panorama.setVisible(false);
        }
      });
    }

    function fetchDetailsForCurrent() {
      const place = lastResults[currentIndex];
      if (!place) return;
      service.getDetails({
        placeId: place.place_id,
        language: 'ja',
        fields: ['name','formatted_address','formatted_phone_number','opening_hours','website','url','photos','geometry']
      }, (details, status) => {
        if (status !== google.maps.places.PlacesServiceStatus.OK || !details) {
          alert('è©³ç´°æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          return;
        }
        // ç”»é¢æ›´æ–°
        document.getElementById('name').textContent = details.name || place.name;
        document.getElementById('addr').textContent = details.formatted_address || place.vicinity || '';
        if (details.photos?.length) {
          document.getElementById('photo').src = details.photos[0].getUrl({ maxWidth: 1200, maxHeight: 800 });
          document.getElementById('photo').hidden = false;
        }
        if (details.formatted_phone_number) {
          const callLink = document.getElementById('callLink');
          callLink.href = `tel:${details.formatted_phone_number.replace(/\s/g,'')}`;
          callLink.hidden = false;
        }
        // Googleãƒãƒƒãƒ—å…¬å¼ URL ãŒæ‰‹ã«å…¥ã‚Œã°å·®ã—æ›¿ãˆ
        if (details.url) {
          document.getElementById('gmapLink').href = details.url;
        }
        // ãƒãƒƒãƒ—ä½ç½®ã‚’ã‚ˆã‚Šæ­£ç¢ºã«
        if (details.geometry?.location) {
          map.panTo(details.geometry.location);
          marker.setPosition(details.geometry.location);
        }
      });
    }
  </script>
  <!-- â–¼â–¼â–¼ ã‚ãªãŸã® API ã‚­ãƒ¼ã«å·®ã—æ›¿ãˆ â–¼â–¼â–¼
       * é‡è¦: APIã‚­ãƒ¼ã¯ HTTP ãƒªãƒ•ã‚¡ãƒ©åˆ¶é™ã‚’è¨­å®šã—ã¦ãã ã•ã„
       * ä¾‹: http://localhost:*, https://yourdomain.example/*
  -->

  <script src="./config.js"></script>
  <script>
    (function () {
      const key = window.CONFIG?.GOOGLE_MAPS_API_KEY;
      if (!key) {
        alert("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");
        return;
      }
      const s = document.createElement("script");
      s.async = true;
      s.src =
        "https://maps.googleapis.com/maps/api/js" +
        `?key=${encodeURIComponent(key)}` +
        "&loading=async&libraries=places&language=ja&region=JP&callback=initMap";
      document.head.appendChild(s);
    })();
    </script>
</body>
</html>
